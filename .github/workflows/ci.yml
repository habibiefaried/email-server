name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: emailuser
          POSTGRES_PASSWORD: emailpass
          POSTGRES_DB: emaildb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.7'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Download dependencies
        run: go mod download

      - name: Run unit tests
        run: go test ./... -v -race -coverprofile=coverage.out

      - name: Build email server
        run: go build -o email-server ./cmd/email-server

      - name: Start email server in background
        env:
          DB_URL: "user=emailuser password=emailpass dbname=emaildb host=localhost port=5432 sslmode=disable"
          HTTP_PORT: "48080"
        run: |
          ./email-server &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          
          # Wait for server to be ready
          echo "Waiting for email server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:48080/ > /dev/null; then
              echo "Email server is ready!"
              break
            fi
            echo "Attempt $i/30: Server not ready yet..."
            sleep 1
          done
          
          # Verify server is running
          if ! curl -s http://localhost:48080/ > /dev/null; then
            echo "Failed to start email server"
            exit 1
          fi

      - name: Install swaks (SMTP testing tool)
        run: sudo apt-get update && sudo apt-get install -y swaks

      - name: Load sample data via SMTP
        run: |
          echo "Loading gmail.txt sample..."
          swaks --to admin@test.milahabibie.com \
                --from habibie.faried@paidy.com \
                --server localhost:2525 \
                --data samples/gmail.txt \
                || echo "Failed to send gmail.txt"
          
          echo "Loading anonymousemail.txt sample..."
          swaks --to admin2@test.milahabibie.com \
                --from noreply@anonymousemail.se \
                --server localhost:2525 \
                --data samples/anonymousemail.txt \
                || echo "Failed to send anonymousemail.txt"
          
          echo "Loading attachments.txt sample..."
          swaks --to admin@test.milahabibie.com \
                --from habibie.faried@paidy.com \
                --server localhost:2525 \
                --data samples/attachments.txt \
                || echo "Failed to send attachments.txt"
          
          # Wait for emails to be processed
          sleep 2
          echo "Sample data loaded!"

      - name: Generate and send custom test emails
        run: |
          echo "Generating 5 custom test emails..."
          
          # Email 1: Simple text email
          swaks --to testuser@example.com \
                --from sender1@test.com \
                --server localhost:2525 \
                --header "Subject: Test Email 1 - Simple Text" \
                --body "This is a simple test email generated by CI pipeline." \
                || echo "Failed to send email 1"
          
          # Email 2: Email with HTML content
          swaks --to testuser@example.com \
                --from sender2@test.com \
                --server localhost:2525 \
                --header "Subject: Test Email 2 - HTML Content" \
                --body "<html><body><h1>Hello from CI</h1><p>This is an HTML email.</p></body></html>" \
                --add-header "Content-Type: text/html" \
                || echo "Failed to send email 2"
          
          # Email 3: Email with special characters
          swaks --to testuser@example.com \
                --from sender3@test.com \
                --server localhost:2525 \
                --header "Subject: Test Email 3 - Special Chars: æ—¥æœ¬èªž ðŸŽ‰" \
                --body "Testing special characters: Ã¡Ã©Ã­Ã³Ãº Ã± ä¸­æ–‡ æ—¥æœ¬èªž í•œê¸€ ðŸš€ âœ… ðŸ’¯" \
                || echo "Failed to send email 3"
          
          # Email 4: Email to different recipient
          swaks --to anotheruser@example.com \
                --from automated@ci.test \
                --server localhost:2525 \
                --header "Subject: CI Test Email 4 - Different Recipient" \
                --body "This email is sent to a different recipient for testing isolation." \
                || echo "Failed to send email 4"
          
          # Email 5: Email with long body
          swaks --to testuser@example.com \
                --from bulk@sender.com \
                --server localhost:2525 \
                --header "Subject: Test Email 5 - Long Content" \
                --body "$(printf 'Line %d: This is a test email with a longer body to verify the system handles larger content properly.\n' {1..50})" \
                || echo "Failed to send email 5"
          
          # Wait for emails to be processed
          sleep 2
          echo "âœ“ Generated and sent 5 custom test emails!"

      - name: Test API - Health check
        run: |
          echo "Testing health check endpoint..."
          response=$(curl -s http://localhost:48080/)
          if [ "$response" = "OK" ]; then
            echo "âœ“ Health check passed"
          else
            echo "âœ— Health check failed: $response"
            exit 1
          fi

      - name: Test API - Valid address with data
        run: |
          echo "Testing valid address: admin@test.milahabibie.com (should have 2 emails)..."
          response=$(curl -s "http://localhost:48080/inbox?email=admin@test.milahabibie.com")
          count=$(echo "$response" | jq '. | length')
          
          if [ "$count" -eq 2 ]; then
            echo "âœ“ Found $count emails for admin@test.milahabibie.com"
          else
            echo "âœ— Expected 2 emails, got $count"
            echo "Response: $response"
            exit 1
          fi
          
          # Verify inbox summary structure (no body/attachments)
          if echo "$response" | jq -e '.[0] | has("id", "from", "to", "subject", "created_at")' > /dev/null; then
            echo "âœ“ Inbox summary structure is valid"
          else
            echo "âœ— Inbox summary structure is invalid"
            exit 1
          fi
          
          # Verify id is UUIDv7 format (8-4-4-4-12 hex with version 7)
          id=$(echo "$response" | jq -r '.[0].id')
          if echo "$id" | grep -qE '^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$'; then
            echo "âœ“ ID is valid UUIDv7 format: $id"
          else
            echo "âœ— ID is not valid UUIDv7 format: $id"
            exit 1
          fi
          
          # Verify inbox does NOT contain body field
          if echo "$response" | jq -e '.[0] | has("body")' > /dev/null 2>&1; then
            echo "âœ— Inbox should not contain body field"
            exit 1
          else
            echo "âœ“ Inbox correctly excludes body field"
          fi

      - name: Test API - Email detail by ID
        run: |
          echo "Testing email detail endpoint..."
          inbox=$(curl -s "http://localhost:48080/inbox?email=admin@test.milahabibie.com")
          email_id=$(echo "$inbox" | jq -r '.[0].id')
          
          echo "Fetching detail for email: $email_id"
          detail=$(curl -s "http://localhost:48080/email?id=$email_id")
          
          # Verify detail structure has body and attachments
          if echo "$detail" | jq -e 'has("id", "from", "to", "subject", "body", "created_at", "attachments")' > /dev/null; then
            echo "âœ“ Email detail structure is valid"
          else
            echo "âœ— Email detail structure is invalid"
            echo "Response: $detail"
            exit 1
          fi
          
          # Verify body is present
          body=$(echo "$detail" | jq -r '.body // empty')
          if [ ! -z "$body" ]; then
            echo "âœ“ Email body present (length: ${#body})"
          else
            echo "âš  Email body is empty (may be expected for some emails)"
          fi

      - name: Test API - Email not found (404)
        run: |
          echo "Testing non-existent email ID..."
          http_code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:48080/email?id=00000000-0000-7000-8000-000000000000")
          
          if [ "$http_code" -eq 404 ]; then
            echo "âœ“ Correctly returned 404 for non-existent email"
          else
            echo "âœ— Expected 404, got $http_code"
            exit 1
          fi

      - name: Test API - Missing email ID parameter
        run: |
          echo "Testing missing 'id' parameter..."
          http_code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:48080/email")
          
          if [ "$http_code" -eq 400 ]; then
            echo "âœ“ Correctly returned 400 for missing ID"
          else
            echo "âœ— Expected 400, got $http_code"
            exit 1
          fi

      - name: Test API - Another valid address
        run: |
          echo "Testing valid address: admin2@test.milahabibie.com (should have 1 email)..."
          response=$(curl -s "http://localhost:48080/inbox?email=admin2@test.milahabibie.com")
          count=$(echo "$response" | jq '. | length')
          
          if [ "$count" -eq 1 ]; then
            echo "âœ“ Found $count email for admin2@test.milahabibie.com"
          else
            echo "âœ— Expected 1 email, got $count"
            echo "Response: $response"
            exit 1
          fi

      - name: Test API - Address not found
        run: |
          echo "Testing non-existent address: notfound@example.com..."
          response=$(curl -s "http://localhost:48080/inbox?email=notfound@example.com")
          count=$(echo "$response" | jq '. | length')
          
          if [ "$count" -eq 0 ]; then
            echo "âœ“ Correctly returned empty array for non-existent address"
          else
            echo "âœ— Expected empty array, got $count emails"
            echo "Response: $response"
            exit 1
          fi

      - name: Test API - Missing required parameter
        run: |
          echo "Testing missing 'email' parameter..."
          http_code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:48080/inbox")
          
          if [ "$http_code" -eq 400 ]; then
            echo "âœ“ Correctly returned 400 Bad Request"
          else
            echo "âœ— Expected 400, got $http_code"
            exit 1
          fi

      - name: Test API - Pagination with offset
        run: |
          echo "Testing pagination with offset=1..."
          response=$(curl -s "http://localhost:48080/inbox?email=admin@test.milahabibie.com&offset=1")
          count=$(echo "$response" | jq '. | length')
          
          if [ "$count" -eq 1 ]; then
            echo "âœ“ Offset parameter works correctly (got remaining 1 email)"
          else
            echo "âœ— Expected 1 email with offset=1, got $count"
            echo "Response: $response"
            exit 1
          fi

      - name: Test API - Negative offset
        run: |
          echo "Testing negative offset (should be ignored/default to 0)..."
          response=$(curl -s "http://localhost:48080/inbox?email=admin@test.milahabibie.com&offset=-5")
          count=$(echo "$response" | jq '. | length')
          
          # Should fall back to offset 0 and return all emails
          if [ "$count" -eq 2 ]; then
            echo "âœ“ Negative offset handled correctly"
          else
            echo "âœ— Expected 2 emails with negative offset, got $count"
            exit 1
          fi

      - name: Test API - Attachment metadata via detail endpoint
        run: |
          echo "Testing attachment metadata via /email detail..."
          inbox=$(curl -s "http://localhost:48080/inbox?email=admin@test.milahabibie.com")
          
          # Try each email to find one with attachments
          found_attachments=false
          for id in $(echo "$inbox" | jq -r '.[].id'); do
            detail=$(curl -s "http://localhost:48080/email?id=$id")
            att_count=$(echo "$detail" | jq '.attachments | length')
            
            if [ "$att_count" -gt 0 ]; then
              found_attachments=true
              echo "âœ“ Found email with $att_count attachment(s): $id"
              
              # Verify attachment structure
              if echo "$detail" | jq -e '.attachments[0] | has("id", "filename", "content_type", "size")' > /dev/null; then
                echo "âœ“ Attachment metadata structure is valid"
              else
                echo "âœ— Attachment metadata structure is invalid"
                exit 1
              fi
              
              # Verify attachment ID is UUIDv7
              att_id=$(echo "$detail" | jq -r '.attachments[0].id')
              if echo "$att_id" | grep -qE '^[0-9a-f]{8}-[0-9a-f]{4}-7[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$'; then
                echo "âœ“ Attachment ID is valid UUIDv7: $att_id"
              else
                echo "âœ— Attachment ID is not valid UUIDv7: $att_id"
                exit 1
              fi
              break
            fi
          done
          
          if [ "$found_attachments" = false ]; then
            echo "âš  No attachments found (this might be expected depending on email parsing)"
          fi

      - name: Test API - Empty email address
        run: |
          echo "Testing empty email address..."
          http_code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:48080/inbox?email=")
          
          if [ "$http_code" -eq 400 ]; then
            echo "âœ“ Correctly returned 400 for empty address"
          else
            echo "âœ— Expected 400, got $http_code"
            exit 1
          fi

      - name: Test API - CORS headers
        run: |
          echo "Testing CORS headers on /inbox..."
          headers=$(curl -s -i "http://localhost:48080/inbox?email=admin@test.milahabibie.com" | head -20)
          
          if echo "$headers" | grep -qi "Access-Control-Allow-Origin"; then
            echo "âœ“ CORS headers present on /inbox"
          else
            echo "âœ— CORS headers missing on /inbox"
            exit 1
          fi
          
          echo "Testing CORS headers on /email..."
          inbox=$(curl -s "http://localhost:48080/inbox?email=admin@test.milahabibie.com")
          email_id=$(echo "$inbox" | jq -r '.[0].id')
          headers=$(curl -s -i "http://localhost:48080/email?id=$email_id" | head -20)
          
          if echo "$headers" | grep -qi "Access-Control-Allow-Origin"; then
            echo "âœ“ CORS headers present on /email"
          else
            echo "âœ— CORS headers missing on /email"
            exit 1
          fi

      - name: Test API - Custom generated emails for testuser@example.com
        run: |
          echo "Testing custom generated emails: testuser@example.com (should have 4 emails)..."
          response=$(curl -s "http://localhost:48080/inbox?email=testuser@example.com")
          count=$(echo "$response" | jq '. | length')
          
          if [ "$count" -eq 4 ]; then
            echo "âœ“ Found $count custom emails for testuser@example.com"
          else
            echo "âœ— Expected 4 emails, got $count"
            echo "Response: $response"
            exit 1
          fi
          
          # Verify subjects are present
          subjects=$(echo "$response" | jq -r '.[].subject')
          echo "Subjects found:"
          echo "$subjects"

      - name: Test API - Custom email for different recipient
        run: |
          echo "Testing custom email for anotheruser@example.com (should have 1 email)..."
          response=$(curl -s "http://localhost:48080/inbox?email=anotheruser@example.com")
          count=$(echo "$response" | jq '. | length')
          
          if [ "$count" -eq 1 ]; then
            echo "âœ“ Found $count email for anotheruser@example.com"
          else
            echo "âœ— Expected 1 email, got $count"
            echo "Response: $response"
            exit 1
          fi
          
          subject=$(echo "$response" | jq -r '.[0].subject')
          if echo "$subject" | grep -q "Different Recipient"; then
            echo "âœ“ Correct email received: $subject"
          else
            echo "âœ— Unexpected subject: $subject"
            exit 1
          fi

      - name: Test API - Special characters handling
        run: |
          echo "Testing special characters in subject..."
          response=$(curl -s "http://localhost:48080/inbox?email=testuser@example.com")
          
          # Find the special chars email in inbox summary
          special_id=$(echo "$response" | jq -r '.[] | select(.subject | contains("Special Chars")) | .id')
          
          if [ ! -z "$special_id" ]; then
            echo "âœ“ Special character email found in inbox: $special_id"
            
            # Fetch detail to check body
            detail=$(curl -s "http://localhost:48080/email?id=$special_id")
            subject=$(echo "$detail" | jq -r '.subject')
            body=$(echo "$detail" | jq -r '.body')
            echo "  Subject: $subject"
            echo "  Body preview: ${body:0:100}"
          else
            echo "âœ— Special character email not found"
            exit 1
          fi

      - name: Test API - Long content handling
        run: |
          echo "Testing long content email..."
          response=$(curl -s "http://localhost:48080/inbox?email=testuser@example.com")
          
          # Find the long content email in inbox
          long_id=$(echo "$response" | jq -r '.[] | select(.subject | contains("Long Content")) | .id')
          
          if [ ! -z "$long_id" ]; then
            # Fetch detail to check body length
            detail=$(curl -s "http://localhost:48080/email?id=$long_id")
            body_length=$(echo "$detail" | jq -r '.body' | wc -c)
            echo "âœ“ Long content email found (body length: $body_length bytes)"
            
            if [ "$body_length" -gt 1000 ]; then
              echo "âœ“ Long body stored correctly"
            else
              echo "âš  Body seems shorter than expected: $body_length bytes"
            fi
          else
            echo "âœ— Long content email not found"
            exit 1
          fi

      - name: Test API - Total email count across all addresses
        run: |
          echo "Verifying total email count..."
          
          count1=$(curl -s "http://localhost:48080/inbox?email=admin@test.milahabibie.com" | jq '. | length')
          count2=$(curl -s "http://localhost:48080/inbox?email=admin2@test.milahabibie.com" | jq '. | length')
          count3=$(curl -s "http://localhost:48080/inbox?email=testuser@example.com" | jq '. | length')
          count4=$(curl -s "http://localhost:48080/inbox?email=anotheruser@example.com" | jq '. | length')
          
          total=$((count1 + count2 + count3 + count4))
          expected=8  # 2 + 1 + 4 + 1
          
          echo "Email counts:"
          echo "  admin@test.milahabibie.com: $count1"
          echo "  admin2@test.milahabibie.com: $count2"
          echo "  testuser@example.com: $count3"
          echo "  anotheruser@example.com: $count4"
          echo "  Total: $total"
          
          if [ "$total" -eq "$expected" ]; then
            echo "âœ“ Total email count matches expected: $expected"
          else
            echo "âœ— Expected $expected total emails, got $total"
            exit 1
          fi

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

      - name: Cleanup
        if: always()
        run: |
          if [ ! -z "$SERVER_PID" ]; then
            kill $SERVER_PID || true
          fi
